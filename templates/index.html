<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VEO 3 Asset Generator | RMS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 0;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #E91E8C 0%, #8B5CF6 50%, #00D4E8 100%);
            padding: 24px 40px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 20px rgba(233, 30, 140, 0.3);
        }
        
        .logo {
            height: 50px;
            width: auto;
        }
        
        .header-title {
            font-size: 28px;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header-subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.9);
            margin-top: 2px;
        }
        
        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 40px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        
        .section:hover {
            border-color: #E91E8C;
            box-shadow: 0 4px 30px rgba(233, 30, 140, 0.2);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #E91E8C, #00D4E8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #bbb;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input[type="password"],
        input[type="file"],
        textarea {
            width: 100%;
            padding: 14px;
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 12px;
            color: #e0e0e0;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        input:focus,
        textarea:focus {
            outline: none;
            border-color: #E91E8C;
            box-shadow: 0 0 20px rgba(233, 30, 140, 0.3);
        }
        
        textarea {
            min-height: 300px;
            font-family: 'SF Mono', Monaco, monospace;
            resize: vertical;
            line-height: 1.6;
        }
        
        .file-input-wrapper {
            margin-bottom: 16px;
        }
        
        .note {
            background: rgba(233, 30, 140, 0.1);
            border-left: 3px solid #E91E8C;
            padding: 12px 16px;
            margin-top: 12px;
            font-size: 13px;
            color: #ccc;
            border-radius: 6px;
        }
        
        .note strong {
            color: #E91E8C;
        }
        
        .note a {
            color: #00D4E8;
            text-decoration: none;
        }
        
        .note a:hover {
            text-decoration: underline;
        }
        
        button {
            background: linear-gradient(135deg, #E91E8C 0%, #8B5CF6 50%, #00D4E8 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(233, 30, 140, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(233, 30, 140, 0.6);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .batch-manager {
            margin-top: 30px;
        }
        
        .batch-list {
            display: grid;
            gap: 16px;
        }
        
        .batch-card {
            background: #1a1a1a;
            border: 2px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .batch-card:hover {
            border-color: #E91E8C;
        }
        
        .batch-card.active {
            border-color: #00D4E8;
            background: rgba(0, 212, 232, 0.05);
        }
        
        .batch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .batch-id {
            font-weight: 700;
            color: #00D4E8;
            font-size: 14px;
        }
        
        .batch-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active {
            background: linear-gradient(135deg, #E91E8C, #8B5CF6);
            color: white;
        }
        
        .status-complete {
            background: #10b981;
            color: white;
        }
        
        .batch-progress {
            font-size: 13px;
            color: #888;
        }
        
        .job-list {
            margin-top: 24px;
        }
        
        .job {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: all 0.3s;
        }
        
        .job:hover {
            border-color: #E91E8C;
        }
        
        .job-label {
            font-weight: 600;
            color: #ddd;
        }
        
        .job-status {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-queued { background: #333; color: #888; }
        .status-generating { 
            background: linear-gradient(135deg, #8B5CF6, #00D4E8);
            color: white;
            animation: pulse 2s infinite;
        }
        .status-completed { background: #10b981; color: white; }
        .status-failed { background: #ef4444; color: white; }
        
        .job-error {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            border-radius: 6px;
            font-size: 12px;
            color: #ff8080;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 24px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #E91E8C 0%, #8B5CF6 50%, #00D4E8 100%);
            width: 0%;
            transition: width 0.3s;
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }
        
        .stats {
            display: flex;
            gap: 24px;
            margin-top: 16px;
            font-size: 14px;
            color: #888;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-value {
            font-weight: 700;
            color: #fff;
        }
        
        .hidden { display: none; }
        
        .download-btn {
            margin-top: 20px;
            background: linear-gradient(135deg, #10b981, #00D4E8);
        }

        /* Script Formatter Styles */
        .toggle-btn {
            background: #2a2a2a;
            color: #888;
            padding: 12px 20px;
            font-size: 14px;
            text-transform: none;
            letter-spacing: 0;
            box-shadow: none;
            width: 100%;
        }

        .toggle-btn:hover {
            background: #333;
            box-shadow: none;
            transform: none;
        }

        .chunk-card {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .chunk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .chunk-label {
            font-weight: 700;
            color: #00D4E8;
            font-size: 14px;
        }

        .chunk-word-count {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .word-count-good {
            background: #10b981;
            color: white;
        }

        .word-count-warn {
            background: #f59e0b;
            color: white;
        }

        .word-count-bad {
            background: #ef4444;
            color: white;
        }

        .chunk-text {
            color: #ccc;
            font-size: 14px;
            line-height: 1.5;
            font-style: italic;
        }

        #rawTranscript {
            min-height: 150px;
        }

        select {
            width: 100%;
            padding: 14px;
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 12px;
            color: #e0e0e0;
            font-size: 14px;
            margin-bottom: 16px;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #E91E8C;
        }

        .formatter-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .formatter-actions button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="/static/RMS Logo.jpg" alt="RMS Logo" class="logo" onerror="this.style.display='none'">
        <div>
            <div class="header-title">VEO 3 Asset Generator</div>
            <div class="header-subtitle">Rocket Media Solutions</div>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <div class="section">
                <div class="section-title">1. API Configuration</div>
                <label>Kie AI API Key</label>
                <input type="password" id="apiKey" placeholder="c655638addd6acd44f69431550cb7dcd">
                <div class="note">
                    <strong>Tip:</strong> Your API key is saved in your browser. Get yours at <a href="https://kie.ai" target="_blank">kie.ai</a>
                </div>
            </div>

            <div class="section">
                <div class="section-title">2. Upload Avatar Images</div>
                <div class="file-input-wrapper">
                    <label>Normal Avatar (no product)</label>
                    <input type="file" id="avatarNormal" accept="image/*">
                </div>
                <div class="file-input-wrapper">
                    <label>Product Avatar (holding product) - Optional</label>
                    <input type="file" id="avatarProduct" accept="image/*">
                </div>
                <div class="note">
                    Upload two versions: one without product, one holding it. Product avatar only needed for segments marked <strong>"‚Äî HOLDING PRODUCT"</strong>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üìù Script Formatter (Optional)</div>
            <p style="color: #888; font-size: 13px; margin-bottom: 16px;">
                Paste a raw transcript and we'll automatically chunk it into Veo 3-ready prompts.
            </p>

            <button class="toggle-btn" onclick="toggleFormatter()">
                ‚ñº Open Script Formatter
            </button>

            <div id="formatterContent" class="hidden">
                <div style="margin-top: 16px;">
                    <label>Raw Transcript</label>
                    <textarea id="rawTranscript" placeholder="Paste your raw transcript here..."></textarea>
                </div>

                <label style="margin-top: 16px;">Tonality</label>
                <select id="tonality">
                    <option value="an informational tone">Informational (default)</option>
                    <option value="an urgent/concerned tone">Urgent/Concerned</option>
                    <option value="an excited tone">Excited</option>
                    <option value="a serious/warning tone">Serious/Warning</option>
                </select>

                <button onclick="generateChunks()">‚úÇÔ∏è Generate Chunks</button>

                <div id="chunksPreview" class="hidden">
                    <div class="section-title" style="margin-top: 20px;">Preview</div>
                    <div id="chunksList"></div>

                    <div class="stats" style="margin-top: 16px;">
                        <div class="stat-item">
                            <span>Chunks:</span>
                            <span class="stat-value" id="chunkCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span>Total Words:</span>
                            <span class="stat-value" id="totalWords">0</span>
                        </div>
                        <div class="stat-item">
                            <span>Avg Words/Chunk:</span>
                            <span class="stat-value" id="avgWords">0</span>
                        </div>
                    </div>

                    <div class="formatter-actions">
                        <button onclick="copyChunks()">üìã Copy All</button>
                        <button onclick="useChunks()">‚¨áÔ∏è Use in Script Field</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">3. Paste Formatted Script</div>
            <textarea id="script" placeholder="Backend 1 
NO CAPTIONS ON SCREEN. NO CAMERA MOVEMENTS. NO EDITS. NO BACKGROUND MUSIC. Handheld phone video style. Make the avatar say...

Backend 2 ‚Äî HOLDING PRODUCT
NO CAPTIONS ON SCREEN..."></textarea>
            <div class="note">
                <strong>How it works:</strong>
                <ul style="margin: 8px 0 0 20px; font-size: 13px; line-height: 1.6;">
                    <li>Normal segments ‚Üí uses normal avatar image</li>
                    <li>Segments with "‚Äî HOLDING PRODUCT" ‚Üí uses product avatar image</li>
                    <li>Each segment generates exactly 1 video with the correct avatar</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <button id="generateBtn" onclick="startGeneration()">üöÄ Generate Videos</button>
        </div>

        <div class="batch-manager hidden" id="batchManager">
            <div class="section">
                <div class="section-title">üìä Batch Manager</div>
                <div class="batch-list" id="batchList"></div>
            </div>
        </div>

        <div class="section hidden" id="progressSection">
            <div class="section-title">Generation Progress</div>
            <div class="stats">
                <div class="stat-item">
                    <span>Total:</span>
                    <span class="stat-value" id="totalJobs">0</span>
                </div>
                <div class="stat-item">
                    <span>Completed:</span>
                    <span class="stat-value" id="completedJobs">0</span>
                </div>
                <div class="stat-item">
                    <span>Failed:</span>
                    <span class="stat-value" id="failedJobs">0</span>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="job-list" id="jobList"></div>
            <button id="downloadBtn" class="download-btn hidden" onclick="downloadBatch()">üì• Download All Videos</button>
        </div>
    </div>

    <script>
        let activeBatches = JSON.parse(localStorage.getItem('veo_batches') || '{}');
        let currentBatchId = null;
        let pollInterval = null;

        // Load saved API key
        window.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('kie_api_key');
            if (savedKey) document.getElementById('apiKey').value = savedKey;
            updateBatchManager();
        });

        // Save API key on change
        document.getElementById('apiKey').addEventListener('change', (e) => {
            localStorage.setItem('kie_api_key', e.target.value);
        });

        async function startGeneration() {
            const apiKey = document.getElementById('apiKey').value;
            const script = document.getElementById('script').value;
            const avatarNormal = document.getElementById('avatarNormal').files[0];
            const avatarProduct = document.getElementById('avatarProduct').files[0];

            if (!apiKey || !script) {
                alert('Please provide API key and script');
                return;
            }

            if (!avatarNormal) {
                alert('Please upload the normal avatar image');
                return;
            }

            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').textContent = '‚è≥ Uploading avatars...';

            try {
                // Upload avatars
                const formDataNormal = new FormData();
                formDataNormal.append('file', avatarNormal);
                formDataNormal.append('api_key', apiKey);

                const uploadNormalResponse = await fetch('/api/upload-avatar', {
                    method: 'POST',
                    body: formDataNormal
                });

                const uploadNormalData = await uploadNormalResponse.json();
                if (uploadNormalData.error) throw new Error(uploadNormalData.error);

                let avatarProductUrl = null;

                if (avatarProduct) {
                    const formDataProduct = new FormData();
                    formDataProduct.append('file', avatarProduct);
                    formDataProduct.append('api_key', apiKey);

                    const uploadProductResponse = await fetch('/api/upload-avatar', {
                        method: 'POST',
                        body: formDataProduct
                    });

                    const uploadProductData = await uploadProductResponse.json();
                    if (uploadProductData.error) throw new Error(uploadProductData.error);
                    avatarProductUrl = uploadProductData.avatar_url;
                }

                document.getElementById('generateBtn').textContent = '‚è≥ Generating videos...';

                // Generate videos
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        api_key: apiKey, 
                        script: script,
                        avatar_normal_url: uploadNormalData.avatar_url,
                        avatar_product_url: avatarProductUrl
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                // Save batch
                currentBatchId = data.batch_id;
                activeBatches[currentBatchId] = {
                    id: currentBatchId,
                    created: Date.now(),
                    status: 'active',
                    jobs: data.jobs
                };
                localStorage.setItem('veo_batches', JSON.stringify(activeBatches));
                
                displayJobs(data.jobs);
                document.getElementById('progressSection').classList.remove('hidden');
                document.getElementById('batchManager').classList.remove('hidden');
                updateBatchManager();
                
                // Re-enable button immediately so user can start another batch
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('generateBtn').textContent = 'üöÄ Generate Videos';
                
                // Start polling
                if (pollInterval) clearInterval(pollInterval);
                pollInterval = setInterval(() => pollStatus(apiKey), 5000);
                pollStatus(apiKey);
                
            } catch (error) {
                alert(`Error: ${error.message}`);
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('generateBtn').textContent = 'üöÄ Generate Videos';
            }
        }

        async function pollStatus(apiKey) {
            if (!currentBatchId) return;

            try {
                const response = await fetch(`/api/status/${currentBatchId}?api_key=${apiKey}`);
                const data = await response.json();
                
                if (data.jobs) {
                    displayJobs(data.jobs);
                    updateStats(data.jobs);
                    
                    // Update batch
                    activeBatches[currentBatchId].jobs = data.jobs;
                    localStorage.setItem('veo_batches', JSON.stringify(activeBatches));

                    // Check if all done
                    const allDone = data.jobs.every(j => j.status === 'completed' || j.status === 'failed');
                    if (allDone) {
                        clearInterval(pollInterval);
                        activeBatches[currentBatchId].status = 'complete';
                        localStorage.setItem('veo_batches', JSON.stringify(activeBatches));
                        updateBatchManager();
                        document.getElementById('downloadBtn').classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Poll error:', error);
            }
        }

        function displayJobs(jobs) {
            const container = document.getElementById('jobList');
            container.innerHTML = jobs.map(job => {
                let statusText = job.status;
                if (job.retry_count && job.retry_count > 0 && job.status !== 'completed') {
                    statusText = `${job.status} (Retry ${job.retry_count}/${job.max_retries})`;
                }
                
                let errorHtml = '';
                if (job.error && job.status === 'failed') {
                    errorHtml = `<div class="job-error">‚ö†Ô∏è ${job.error}</div>`;
                }
                
                return `
                    <div class="job">
                        <div>
                            <div class="job-label">${job.label}</div>
                            ${errorHtml}
                        </div>
                        <div class="job-status status-${job.status}">${statusText}</div>
                    </div>
                `;
            }).join('');
        }

        function updateStats(jobs) {
            const total = jobs.length;
            const completed = jobs.filter(j => j.status === 'completed').length;
            const failed = jobs.filter(j => j.status === 'failed').length;

            document.getElementById('totalJobs').textContent = total;
            document.getElementById('completedJobs').textContent = completed;
            document.getElementById('failedJobs').textContent = failed;

            const progress = (completed + failed) / total * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        function updateBatchManager() {
            const container = document.getElementById('batchList');
            const batches = Object.values(activeBatches).sort((a, b) => b.created - a.created);
            
            if (batches.length === 0) {
                container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No batches yet</div>';
                return;
            }
            
            container.innerHTML = batches.map(batch => {
                const completed = batch.jobs.filter(j => j.status === 'completed').length;
                const total = batch.jobs.length;
                const isActive = batch.id === currentBatchId;
                
                return `
                    <div class="batch-card ${isActive ? 'active' : ''}" onclick="switchBatch('${batch.id}')">
                        <div class="batch-header">
                            <div class="batch-id">Batch ${batch.id}</div>
                            <div class="batch-status status-${batch.status}">
                                ${batch.status === 'active' ? '‚ö° Active' : '‚úì Complete'}
                            </div>
                        </div>
                        <div class="batch-progress">${completed}/${total} videos complete</div>
                    </div>
                `;
            }).join('');
        }

        function switchBatch(batchId) {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }
            
            currentBatchId = batchId;
            const batch = activeBatches[batchId];
            
            if (batch) {
                displayJobs(batch.jobs);
                updateStats(batch.jobs);
                document.getElementById('progressSection').classList.remove('hidden');
                updateBatchManager();
                
                // Resume polling if active
                if (batch.status === 'active') {
                    if (pollInterval) clearInterval(pollInterval);
                    pollInterval = setInterval(() => pollStatus(apiKey), 5000);
                    pollStatus(apiKey);
                } else {
                    document.getElementById('downloadBtn').classList.remove('hidden');
                }
            }
        }

        async function downloadBatch() {
            if (!currentBatchId) return;

            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('downloadBtn').textContent = '‚è≥ Preparing ZIP...';

            try {
                const response = await fetch(`/api/download/${currentBatchId}`, {
                    method: 'POST'
                });

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `veo3_batch_${currentBatchId}.zip`;
                a.click();

                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('downloadBtn').textContent = 'üì• Download All Videos';
            } catch (error) {
                alert(`Download error: ${error.message}`);
                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('downloadBtn').textContent = 'üì• Download All Videos';
            }
        }

        // ========== Script Formatter Functions ==========

        function toggleFormatter() {
            const content = document.getElementById('formatterContent');
            const btn = event.target;
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                btn.textContent = '‚ñ≤ Close Script Formatter';
            } else {
                content.classList.add('hidden');
                btn.textContent = '‚ñº Open Script Formatter';
            }
        }

        function generateChunks() {
            const rawText = document.getElementById('rawTranscript').value.trim();
            const tonality = document.getElementById('tonality').value;

            if (!rawText) {
                alert('Please paste a transcript first');
                return;
            }

            // Split into sentences (handle ., !, ?)
            const sentences = rawText.match(/[^.!?]+[.!?]+/g) || [rawText];

            const chunks = [];
            let currentChunk = [];
            let currentWordCount = 0;

            for (const sentence of sentences) {
                const trimmed = sentence.trim();
                const words = trimmed.split(/\s+/);
                const sentenceWordCount = words.length;

                // If adding this sentence keeps us in acceptable range, add it
                if (currentWordCount + sentenceWordCount <= 28) {
                    currentChunk.push(trimmed);
                    currentWordCount += sentenceWordCount;
                } else {
                    // Save current chunk if it has content
                    if (currentChunk.length > 0) {
                        chunks.push(currentChunk.join(' '));
                    }
                    // Start new chunk with this sentence
                    currentChunk = [trimmed];
                    currentWordCount = sentenceWordCount;
                }
            }

            // Don't forget the last chunk
            if (currentChunk.length > 0) {
                chunks.push(currentChunk.join(' '));
            }

            // Format chunks with labels and prompts
            const formattedChunks = chunks.map((chunk, index) => {
                let label;
                if (index === 0) {
                    label = 'HOOK';
                } else if (index === 1 && chunks[0].split(/\s+/).length < 20) {
                    label = 'HOOK V2';
                } else {
                    label = `Backend ${index}`;
                }

                const wordCount = chunk.split(/\s+/).length;

                return {
                    label,
                    text: chunk,
                    wordCount,
                    formatted: `${label}\nNO CAPTIONS ON SCREEN. NO CAMERA MOVEMENTS. NO EDITS. NO BACKGROUND MUSIC.\nHandheld phone video style, Make the avatar say in ${tonality}:\n"${chunk}"`
                };
            });

            // Re-number backend labels sequentially
            let backendNum = 1;
            formattedChunks.forEach((chunk, index) => {
                if (index > 0 && !chunk.label.includes('HOOK')) {
                    chunk.label = `Backend ${backendNum}`;
                    chunk.formatted = chunk.formatted.replace(/^Backend \d+/, `Backend ${backendNum}`);
                    backendNum++;
                }
            });

            // Store for later use
            window.generatedChunks = formattedChunks;

            // Display preview
            displayChunksPreview(formattedChunks);
        }

        function displayChunksPreview(chunks) {
            const container = document.getElementById('chunksList');
            const totalWords = chunks.reduce((sum, c) => sum + c.wordCount, 0);
            const avgWords = (totalWords / chunks.length).toFixed(1);

            container.innerHTML = chunks.map(chunk => {
                let wordCountClass = 'word-count-good';
                if (chunk.wordCount < 23 || chunk.wordCount > 28) {
                    wordCountClass = 'word-count-bad';
                } else if (chunk.wordCount < 25 || chunk.wordCount > 27) {
                    wordCountClass = 'word-count-warn';
                }

                return `
                    <div class="chunk-card">
                        <div class="chunk-header">
                            <span class="chunk-label">${chunk.label}</span>
                            <span class="chunk-word-count ${wordCountClass}">${chunk.wordCount} words</span>
                        </div>
                        <div class="chunk-text">"${chunk.text}"</div>
                    </div>
                `;
            }).join('');

            document.getElementById('chunkCount').textContent = chunks.length;
            document.getElementById('totalWords').textContent = totalWords;
            document.getElementById('avgWords').textContent = avgWords;
            document.getElementById('chunksPreview').classList.remove('hidden');
        }

        function copyChunks() {
            if (!window.generatedChunks) return;
            const fullText = window.generatedChunks.map(c => c.formatted).join('\n\n');
            navigator.clipboard.writeText(fullText);
            alert('Copied to clipboard!');
        }

        function useChunks() {
            if (!window.generatedChunks) return;
            const fullText = window.generatedChunks.map(c => c.formatted).join('\n\n');
            document.getElementById('script').value = fullText;

            // Collapse formatter and scroll to script section
            document.getElementById('formatterContent').classList.add('hidden');
            document.querySelector('.toggle-btn').textContent = '‚ñº Open Script Formatter';
            document.getElementById('script').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
